name: Go CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.22"
        check-latest: true
        cache: true

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -v || echo "No tests found"

    - name: Build App
      run: go build -o ums-backend main.go

    - name: Verify Build
      run: |
        if [ -f "ums-backend" ]; then
          echo "‚úÖ Build successful!"
          ls -lh ums-backend
        else
          echo "‚ùå Build failed - binary not found"
          exit 1
        fi

  # Optional: Deploy via Render API (requires secrets)
  # If you have render.yaml with autoDeploy: true, this step is not needed
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Deploy to Render
      env:
        RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK" ]; then
          echo "‚ö†Ô∏è  RENDER_DEPLOY_HOOK not set - skipping manual deploy"
          echo "üìù Render will auto-deploy if render.yaml is configured with autoDeploy: true"
          echo "‚úÖ Build passed - Render will deploy automatically on push to main"
          exit 0
        fi
        
        echo "üöÄ Triggering Render deployment via webhook..."
        response=$(curl -s -w "\n%{http_code}" -X POST "$RENDER_DEPLOY_HOOK")
        
        http_code=$(echo "$response" | tail -n1)
        
        if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
          echo "‚úÖ Deployment triggered successfully!"
        else
          echo "‚ö†Ô∏è  Deployment webhook returned status $http_code"
          echo "üìù Check Render dashboard for deployment status"
        fi
