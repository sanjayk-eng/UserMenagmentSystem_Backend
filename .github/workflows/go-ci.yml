name: Go CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.22"
        check-latest: true
        cache: true

    - name: Install dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -v || echo "âš ï¸  No tests found"

    - name: Build App
      run: go build -o ums-backend main.go

    - name: Verify Build
      run: |
        if [ -f "ums-backend" ]; then
          echo "âœ… Build successful!"
          ls -lh ums-backend
        else
          echo "âŒ Build failed - binary not found"
          exit 1
        fi

    - name: Deployment Status
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "âœ… Build passed - Render will auto-deploy this commit"
        echo "ğŸ“ Check deployment: https://dashboard.render.com/"

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Trigger Render Deploy
      env:
        DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      run: |
        if [ -z "$DEPLOY_HOOK" ]; then
          echo "âš ï¸  RENDER_DEPLOY_HOOK secret not configured"
          echo "âœ… Render will auto-deploy via GitHub integration"
          echo "ğŸ“ No manual trigger needed"
          exit 0
        fi
        
        echo "ğŸš€ Triggering Render deployment via webhook..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$DEPLOY_HOOK")
        
        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo "âœ… Deployment triggered successfully (HTTP $HTTP_CODE)"
        else
          echo "âš ï¸  Webhook returned HTTP $HTTP_CODE"
          echo "ğŸ“ Check Render dashboard for deployment status"
        fi
