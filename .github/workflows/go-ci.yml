name: Go CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
   
    - name: Checkout code
      uses: actions/checkout@v4


    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.22"
        check-latest: true
        cache: true

   
    - name: Install dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -v || echo "âš ï¸ No tests found"

    - name: Build App
      run: go build -o ums-backend main.go

  
    - name: Verify Build
      run: |
        if [ -f "ums-backend" ]; then
          echo "âœ… Build successful!"
          ls -lh ums-backend
        else
          echo "âŒ Build failed - binary not found"
          exit 1
        fi

    # 7ï¸âƒ£ Deploy to Render
    - name: Deploy to Render
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      env:
        RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK" ]; then
          echo "âš ï¸ RENDER_DEPLOY_HOOK secret not configured"
          echo "âœ… Render will auto-deploy via GitHub integration"
        else
          echo "ğŸš€ Triggering manual deploy via webhook..."
          curl -X POST "$RENDER_DEPLOY_HOOK"
          echo "âœ… Deploy request sent!"
        fi

    # 8ï¸âƒ£ Deployment Info
    - name: Deployment Info
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Build & Deployment pipeline completed!"
        echo "ğŸ” Check deployment status at: https://dashboard.render.com/"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
