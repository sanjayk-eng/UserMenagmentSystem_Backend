name: Go CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # âœ… Set environment variable at job level
    env:
      RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}

    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Setup Go
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.22"
        check-latest: true
        cache: true

    # 3ï¸âƒ£ Install dependencies
    - name: Install dependencies
      run: go mod download

    # 4ï¸âƒ£ Run tests
    - name: Run tests
      run: go test ./... -v || echo "âš ï¸ No tests found"

    # 5ï¸âƒ£ Build Go binary
    - name: Build App
      run: go build -o ums-backend main.go

    # 6ï¸âƒ£ Verify Build
    - name: Verify Build
      run: |
        if [ -f "ums-backend" ]; then
          echo "âœ… Build successful!"
          ls -lh ums-backend
        else
          echo "âŒ Build failed - binary not found"
          exit 1
        fi

 
    - name: Deploy to Render
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK" ]; then
          echo "âŒ RENDER_DEPLOY_HOOK secret not configured. Deployment aborted."
          exit 1
        else
          echo "ğŸš€ Triggering manual deploy via webhook..."
          curl -X POST "$RENDER_DEPLOY_HOOK"
          echo "âœ… Deploy request sent!"
        fi

    # 8ï¸âƒ£ Deployment Info
    - name: Deployment Info
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… Build & Deployment pipeline completed!"
        echo "ğŸ” Check deployment status at: https://dashboard.render.com/"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
